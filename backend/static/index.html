<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Enrollment</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background:#6b0f0f;
      color:white;
      max-width:900px;
      margin:auto;
      padding:20px;
    }
    h1 { margin-bottom:5px; }
    h2 { margin-top:20px; }
    table {
      width:100%;
      border-collapse: collapse;
      margin-top:15px;
      background:white;
      color:black;
    }
    th,td {
      border:1px solid #ccc;
      padding:8px;
      text-align:left;
    }
    select, input, button {
      padding:6px;
      margin:4px;
    }
    .hidden { display:none; }
    button { cursor:pointer; }
    label { font-weight:bold; margin-right:6px; }
  </style>
</head>
<body>

<h1>Student Enrollment</h1>
<p>Team 2</p>

<label for="mode">Mode:</label>
<select id="mode">
  <option value="view">View</option>
  <option value="create">Enroll</option>
  <option value="edit">Edit</option>
  <option value="delete">Delete</option>
</select>

<h2 id="form-title">Student Viewer</h2>

<form id="form">
  <!-- Campos para crear / editar -->
  <div id="form-fields" class="hidden">
    <input type="text" id="name" placeholder="Student Name" required />
    <select id="major_id"></select>
    <select id="origin_id"></select>
    <input type="text" id="phone" placeholder="Phone" />
    <input type="text" id="email" placeholder="Email" />
    <input type="hidden" id="edit-id" />
    <button type="submit" id="submit-btn">Create</button>
    <button type="button" id="cancel-btn" class="hidden">Cancel</button>
  </div>

  <!-- Campos para borrar -->
  <div id="delete-box" class="hidden">
    <input type="number" id="delete-id" placeholder="ID to delete" />
    <button type="submit" id="delete-submit-btn">Delete</button>
  </div>
</form>

<h2>Students</h2>

<table>
  <thead>
    <tr>
      <th>ID</th><th>Name</th><th>Major</th><th>Country</th><th>Phone</th><th>Email</th><th>Actions</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const API_BASE = "http://localhost:50000/api";

  // Elementos del DOM
  const modeSel      = document.getElementById("mode");
  const form         = document.getElementById("form");
  const formTitle    = document.getElementById("form-title");
  const formFields   = document.getElementById("form-fields");
  const deleteBox    = document.getElementById("delete-box");
  const submitBtn    = document.getElementById("submit-btn");
  const cancelBtn    = document.getElementById("cancel-btn");
  const deleteIdEl   = document.getElementById("delete-id");

  const nameInput    = document.getElementById("name");
  const majorSel     = document.getElementById("major_id");
  const originSel    = document.getElementById("origin_id");
  const phoneInput   = document.getElementById("phone");
  const emailInput   = document.getElementById("email");
  const editIdInput  = document.getElementById("edit-id");

  const tbody        = document.getElementById("tbody");

  // ---- Cargar catálogos (majors y origins) ----
  async function loadOptions() {
    try {
      const depRes = await fetch(`${API_BASE}/departments`);
      const departments = await depRes.json();

      majorSel.innerHTML =
        `<option value="">Select Major...</option>` +
        departments.map(d => `<option value="${d.major_id}">${d.major}</option>`).join("");

      const oriRes = await fetch(`${API_BASE}/origins`);
      const origins = await oriRes.json();

      //console.log(origins);

      originSel.innerHTML =
        `<option value="">Select Country...</option>` +
        origins.map(o => `<option value="${o.id}">${o.code}</option>`).join("");
    } catch (err) {
      console.error("Error loading options", err);
      majorSel.innerHTML = `<option value="">(error)</option>`;
      originSel.innerHTML = `<option value="">(error)</option>`;
    }
  }

  // ---- Cargar tabla de estudiantes ----
  async function loadStudents() {
    try {
      const res = await fetch(`${API_BASE}/students`);
      const students = await res.json();
      tbody.innerHTML = "";

      students.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.id}</td>
          <td>${s.name}</td>
          <td>${s.major}</td>
          <td>${s.origin}</td>
          <td>${s.phone ?? ""}</td>
          <td>${s.email ?? ""}</td>
          <td>
            <button type="button" data-action="edit" data-id="${s.id}">Edit</button>
            <button type="button" data-action="delete" data-id="${s.id}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (err) {
      console.error("Error loading students", err);
    }
  }

  // ---- Cambiar modo (view / create / edit / delete) ----
  function changeMode() {
    const mode = modeSel.value;

    if (mode === "view") {
      formTitle.textContent = "Student Viewer";
      formFields.classList.add("hidden");
      deleteBox.classList.add("hidden");
      cancelBtn.classList.add("hidden");
    }

    if (mode === "create") {
      formTitle.textContent = "Enroll New Student";
      formFields.classList.remove("hidden");
      deleteBox.classList.add("hidden");
      cancelBtn.classList.add("hidden");
      submitBtn.textContent = "Create";

      // limpiar campos
      form.reset();
      editIdInput.value = "";
    }

    if (mode === "edit") {
      formTitle.textContent = "Edit Student";
      formFields.classList.remove("hidden");
      deleteBox.classList.add("hidden");
      cancelBtn.classList.remove("hidden");
      submitBtn.textContent = "Save Changes";
    }

    if (mode === "delete") {
      formTitle.textContent = "Delete Student";
      formFields.classList.add("hidden");
      deleteBox.classList.remove("hidden");
      cancelBtn.classList.add("hidden");
    }
  }

  modeSel.addEventListener("change", changeMode);

  // ---- Empezar edición al hacer click en botón "Edit" de la tabla ----
  async function startEdit(id) {
    try {
      const res = await fetch(`${API_BASE}/students/${id}`);
      if (!res.ok) {
        alert("Student not found");
        return;
      }
      const s = await res.json();

      modeSel.value = "edit";
      changeMode();

      editIdInput.value = s.id;
      nameInput.value   = s.name;
      majorSel.value    = s.major_id ?? "";
      originSel.value   = s.origin_id ?? "";
      phoneInput.value  = s.phone ?? "";
      emailInput.value  = s.email ?? "";
    } catch (err) {
      console.error("Error loading student", err);
    }
  }

  // ---- Empezar borrado al hacer click en botón "Delete" de la tabla ----
  function startDelete(id) {
    modeSel.value = "delete";
    changeMode();
    deleteIdEl.value = id;
  }

  // Delegación de eventos en la tabla
  tbody.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    const id = btn.dataset.id;
    const action = btn.dataset.action;
    if (!id || !action) return;

    if (action === "edit") {
      startEdit(id);
    } else if (action === "delete") {
      startDelete(id);
    }
  });

  // ---- Submit del formulario ----
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const mode = modeSel.value;

    try {
      if (mode === "create") {
        // validar mínimo
        if (!nameInput.value.trim()) {
          alert("Name is required");
          return;
        }
        if (!majorSel.value || !originSel.value) {
          alert("Major and Country are required");
          return;
        }

        const payload = {
          name:      nameInput.value.trim(),
          major_id:  parseInt(majorSel.value),
          origin_id: parseInt(originSel.value),
          phone:     phoneInput.value.trim() || null,
          email:     emailInput.value.trim() || null
        };

        //console.log("Create payload:", payload);

        const res = await fetch(`${API_BASE}/students`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          console.error("Create error:", err);
          alert("Error creating student");
          return;
        }
      }

      if (mode === "edit") {
        const id = editIdInput.value;
        if (!id) {
          alert("Select a student to edit (use Edit button in table).");
          return;
        }
        if (!nameInput.value.trim()) {
          alert("Name is required");
          return;
        }
        if (!majorSel.value || !originSel.value) {
          alert("Major and Country are required");
          return;
        }

        const payload = {
          name:      nameInput.value.trim(),
          major_id:  parseInt(majorSel.value),
          origin_id: parseInt(originSel.value),
          phone:     phoneInput.value.trim() || null,
          email:     emailInput.value.trim() || null
        };

        const res = await fetch(`${API_BASE}/students/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          console.error("Update error:", err);
          alert("Error updating student");
          return;
        }
      }

      if (mode === "delete") {
        const id = deleteIdEl.value;
        if (!id) {
          alert("Enter an ID to delete.");
          return;
        }

        const res = await fetch(`${API_BASE}/students/${id}`, {
          method: "DELETE"
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          console.error("Delete error:", err);
          alert("Error deleting student");
          return;
        }
      }

      // Después de cualquier operación → recargar tabla y volver a View
      await loadStudents();
      modeSel.value = "view";
      changeMode();
    } catch (err) {
      console.error("Form submit error:", err);
      alert("Unexpected error");
    }
  });

  // Cancelar edición
  cancelBtn.addEventListener("click", () => {
    modeSel.value = "view";
    changeMode();
  });

  // Init
  loadOptions();
  loadStudents();
  changeMode();
});
</script>

</body>
</html>
